# Voice-activated_assistant
試做一個【語音助理】

![語音助理](./image/Voice-activated_assistant.gif)

## 快速啟動
1. **環境準備**：確保已安裝 **.NET 10 SDK**。
2. **啟動程式**：
   在專案根目錄執行以下指令：
   ```powershell
   cd Voice-activated_assistant
   dotnet run
   ```
3. **模型選擇**：啟動後有多種官方模型可供選擇：
   - **選項 1, 3, 4, 5**：官方模型（Tiny, Base, Small, Medium），執行時若本地無檔案將**自動下載**。
   - **選項 2**：繁體中文微調模型 (Tiny-zh-TW)。若本地無檔案，請點擊連結手動下載後放至專案目錄。
4. **使用方式**：
   - 程式啟動後會自動監控麥克風。
   - **聲控自動啟動**：具備 **Pre-roll Buffer (600ms)** 技術，確保開頭單詞（如「嗨」）不被切斷。
   - **靜音自動結束**：說完話後若持續靜音 **1.5 秒**，程式會自動斷句並立即轉錄文字。
   - **狀態顯示**：畫面會顯示當前監聽的 **已過秒數**。
   - **關鍵字互動**：若辨識出的文字包含設定表中的關鍵字，助理會自動進行 TTS 語音回覆。
   - 按下鍵盤 **ESC** 鍵可安全停止並結束程式。

## 核心優化
本專案進行了多項深度優化，以提供更流暢的使用體驗：

1. **完全記憶體運作 (Zero-Disk Usage)**：
   - 移除傳統的實體 `.wav` 檔案寫入。
   - 音訊數據直接在記憶體中處理，轉錄完成後自動釋放，具備極高隱私性且不佔用硬碟空間。

2. **進階語音偵測 (Adaptive VAD)**：
   - **動態底噪追蹤**：自動學習環境背景噪音，動態調整觸發門檻，不論在安靜或吵雜環境皆能保持最佳靈敏度。
   - **峰值觸發技術 (Peak Detection)**：改用瞬間峰值偵測，對起手字與短促音訊的捕捉更為靈敏。
   - **Pre-roll Buffer (600ms)**：循環緩衝最近 600ms 的音訊，確保偵測到聲音時能完整回溯開頭片段。

3. **動態斷句 (Auto-Stop)**：
   - 加入靜音感應機制，取代傳統的固定時長錄音。
   - 說完話後立即進行轉譯，大幅提升互動的即時性。

4. **平行運算加速**：
   - 針對 .NET 10 環境優化多執行緒排程。
   - 自動偵測 CPU 核心數並最大化利用運算資源，顯著提升 Whisper 轉譯速度。

5. **系統長駐與背景執行優化**：
   - **智慧資源調度 (Process Priority)**：自動將處理序優先權設為 `BelowNormal`，確保在背景執行時不干擾遊戲、辦公軟體等主程式。
   - **物件池化 (Object Pooling)**：重複使用錄音器與記憶體緩衝區，取代頻繁的資源建立與銷毀，大幅降低記憶體碎片的產生。
   - **主動記憶體維護 (GC Tuning)**：轉譯完成後自動觸發主動式記憶體回收，適合數日甚至數週的長時間掛載。

6. **幻覺抑制與精準度優化**：
   - **保守解讀模式**：鎖定 `Temperature 0.0`，強制模型僅輸出高信心度的字詞，大幅降低無中生有的「長難句」幻覺。
   - **三重過濾機制**：結合 **語音偵測門檻 (NoSpeech)**、**信心概率 (LogProb)** 與 **背景底噪過濾**，確保安靜環境下畫面的潔淨。
   - **對話引導 (Prompting)**：透過隱形提示語引導模型理解當前為對話狀態，提升「嗨」、「你好」等短促指令的捕捉率。

7. **非同步流水線架構 (Producer-Consumer Pattern)**：
   - **錄音與轉譯併行**：採用多執行緒流水線，錄音器在偵測到停頓後立即將任務派發至背景隊列，並在 0.1 秒內重啟監聽。
   - **邊錄邊轉**：實現了「一邊轉譯上一句話、一邊錄製下一句話」的完全非阻塞體驗，適合高頻率的連續對話。

8. **關鍵字回應引擎 (Keyword Response Engine)**：
   - **JSON 設定化**：支援透過 `keyword_responses.json` 自定義關鍵字與對應台詞，無需修改程式碼即可教導助理新回應。
   - **動態變數**：支援 `{TIME}` 等動態標籤，自動代入當前時間。

9. **實時語音避讓 (Active TTS Avoidance)**：
   - **雙重保護設計**：除了在錄音前檢查 TTS 狀態，監聽中也會實時監測，一旦助理因背景任務開啟語音，監聽器會立即中斷錄音並切換至避讓模式，徹底杜絕自言自語與回授干擾。
## 關鍵字回應設定 (keyword_responses.json)

本專案支援透過 JSON 檔案自定義助理的語音回應內容，無需重新編譯程式即可即時生效。

### 設定說明
1. **檔案位置**：位於專案目錄下的 `keyword_responses.json`。
2. **格式**：採用鍵值對（Key-Value）格式。
   - **Key (關鍵字)**：當轉譯出的文字「包含」此關鍵字時即觸發。
   - **Value (回應內容)**：助理將透過 TTS 說出的台詞。
3. **動態變數**：支援在 Value 中使用 `{TIME}`，程式會自動將其替換為當前的系統時間（HH:mm）。

### 例範樣式
```json
{
  "你好": "你好呀！我是您的語音助理。",
  "現在幾點": "現在時間是 {TIME}。",
  "你是誰": "您可以叫我波弟助手。",
  "謝謝": "不客氣，隨時樂意幫忙！"
}
```

## 模型介紹與特性

本專案提供多種模型選單，使用者可根據硬體效能與準確率需求自由切換：

| 選項 | 模型名稱 | 體積 | 特性 | 下載方式 |
| :--- | :--- | :--- | :--- | :--- |
| **1** | **Tiny** | ~31MB | 極速、省資源，適合低配備 | 自動下載 |
| **2** | **Tiny-zh-TW** | ~74MB | 繁體中文強化、台灣用語優化 | 手動下載 |
| **3** | **Base** | ~73MB | **CP 值王**，比 Tiny 準確且依然極快 | 自動下載 |
| **4** | **Small** | ~153MB | **效能平衡王**，準確度高且反應迅速 | 自動下載 |
| **5** | **Medium** | ~469MB | **幻覺抑制王**，適合中高階配備 | 自動下載 |

### 主要優化特性：
1. **極致輕量化** (Tiny/Base)：適合用於簡單的語音指令捕捉或即時對話摘要。
2. **準確度提升** (Small/Medium)：隨參數增加，模型對長難句及背景噪聲的抵抗力顯著增強。
3. **推論速度**：在 .NET 10 多執行緒優化下，Small 模型在一般電腦上即可達到近乎即時的體驗。

## 繁體中文微調版模型下載
ggml-tiny-zh_tw.bin 模型下載網址:
https://huggingface.co/xmzhu/whisper-tiny-zh-TW/blob/a41e6c9470161b8aa876bd085c780f2396e80164/ggml-tiny-zh_tw.bin
- 74 MB

## 平台相容性說明

本專案目前**僅支援 Windows 作業系統**，無法在 macOS 或 Linux 上直接執行。主要原因如下：

1. **語音錄製 (Audio Recording)**：採用了 `NAudio` 庫，其核心底層依賴於 Windows 獨有的 **WASAPI** 與 **WinMM** API。
2. **語音合成 (TTS)**：採用了 `System.Speech` 庫，這是基於 Windows 內建的 **SAPI (Speech API)** 引擎。
3. **專案目標**：目前的專案檔 (`.csproj`) 鎖定為 `net10.0-windows`，以確保能與上述 Windows 原生組件深度整合並達成低延遲效能。

> [!NOTE]
> 雖然 .NET 10 本身是跨平台的，但若要移植至 macOS，需更換錄音庫（如 CoreAudio 適配層）及 TTS 引擎（如 AVSpeechSynthesizer 介接）。

## .NET 10 升級說明
本專案已從 .NET 6 升級至 **.NET 10**，主要變更包含：

1. **專案檔更新 (`.csproj`)**：
   - 將 `TargetFramework` 修改為 `net10.0-windows` 以支援原生 TTS 與 NAudio 分發。
   - 將 `Whisper.net` 及其 Runtime 套件升級至 **v1.9.0** 以上版本以支援最新的 .NET 特性。

2. **程式碼適配 (Breaking Changes)**：
   - **WhisperGgmlDownloader**：在新版本中改為非靜態方法，需實例化並傳入 `HttpClient`，同時需指定 `QuantizationType`。
   - **事件處理器**：為了符合 .NET 10 的 Nullability 檢查，將 `AudioRecorder` 中的事件參數 `object sender` 更新為 `object? sender`。

3. **環境需求**：
   - 需安裝 **.NET 10 SDK** 才能進行編譯與開發。
   - 建議使用支援 .NET 10 的 IDE（如 Visual Studio 2022 最新版或 VS Code + C# Dev Kit）。

